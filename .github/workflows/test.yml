name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test_x86:
    runs-on: ubuntu-22.04
    container: ubuntu:22.04
    name: x86-64 - all frameworks
    env:
      PYTHONPATH: ./
      COCO_IMG_PATH: aio_objdet_dataset
      COCO_ANNO_PATH: aio_objdet_dataset/annotations.json
      OMP_NUM_THREADS: 2
    steps:
      - name: Install git
        run:
          apt-get update && apt-get install -y git

      - name: Git checkout & pull submodules
        uses: actions/checkout@v3
        with:
          submodules: true
      
      - name: Set up AML
        run:
          FORCE_INSTALL=1 bash setup_deb.sh
      
      - name: AML imports test
        run:
          python3 utils/tests/setup_test_utils/attempt_imports.py
      
      - name: AML smoke test
        run: |            
          wget https://ampereaimodelzoo.s3.eu-central-1.amazonaws.com/aio_objdet_dataset.tar.gz > /dev/null 2>&1
          tar -xvf aio_objdet_dataset.tar.gz > /dev/null
          
          wget https://ampereaimodelzoo.s3.eu-central-1.amazonaws.com/resnet_50_v15_tf_fp32.pb > /dev/null 2>&1
          python3 computer_vision/classification/resnet_50_v15/run.py -m resnet_50_v15_tf_fp32.pb -p fp32 -f tf --timeout=60
          
          python3 computer_vision/classification/mobilenet_v2/run.py -p fp32 -f pytorch --timeout=60
          
          wget https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt > /dev/null 2>&1
          python3 computer_vision/object_detection/yolo_v8/run.py -m yolov8n.pt -f pytorch -p fp32 --timeout=60
          
          python3 speech_recognition/whisper/run.py -m small.en
          
          wget https://ampereaimodelzoo.s3.eu-central-1.amazonaws.com/ssd_inception_v2_tf_fp32.pb > /dev/null 2>&1
          python3 computer_vision/object_detection/ssd_inception_v2/run.py -m ssd_inception_v2_tf_fp32.pb -p fp32 --timeout=60

  test_pytorch_arm64:
    runs-on: self-hosted
    container: amperecomputingai/pytorch:latest
    name: Ampere Altra - Ampere optimized PyTorch
    env:
      PYTHONPATH: ./
      COCO_IMG_PATH: aio_objdet_dataset
      COCO_ANNO_PATH: aio_objdet_dataset/annotations.json
      AIO_NUM_THREADS: 16
    steps:
      - name: Git checkout & pull submodules
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up AML
        run:
          bash setup_deb.sh

      - name: AML smoke test
        run: |
          wget https://ampereaimodelzoo.s3.eu-central-1.amazonaws.com/aio_objdet_dataset.tar.gz > /dev/null 2>&1
          tar -xvf aio_objdet_dataset.tar.gz > /dev/null
          
          IGNORE_DATASET_LIMITS=1 AIO_IMPLICIT_FP16_TRANSFORM_FILTER=".*" python3 computer_vision/classification/resnet_50_v15/run.py -m resnet50 -p fp32 -b 16 -f pytorch
          
          # AIO_IMPLICIT_FP16_TRANSFORM_FILTER=".*" python3 speech_recognition/whisper/run.py -m tiny.en 
          
          python3 computer_vision/classification/mobilenet_v2/run.py -p fp32 -f pytorch --timeout=60
          
          wget https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8l.pt
          AIO_IMPLICIT_FP16_TRANSFORM_FILTER=".*" python3 computer_vision/object_detection/yolo_v8/run.py -m yolov8l.pt -p fp32 -f pytorch              
          
          wget -O bert_large_mlperf.pt https://zenodo.org/records/3733896/files/model.pytorch?download=1
          AIO_IMPLICIT_FP16_TRANSFORM_FILTER=".*" python3 natural_language_processing/extractive_question_answering/bert_large/run_mlperf.py -m bert_large_mlperf.pt -p fp32 -f pytorch

      - name: benchmark.py test
        run: |
          { echo "y"; echo "y"; } | PYTHONPATH=./ python3 benchmark.py